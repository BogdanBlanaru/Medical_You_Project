<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="202602030002-1" author="system">
        <comment>Create chat_messages table for conversation messages</comment>
        <sql>
            CREATE TABLE IF NOT EXISTS chat_messages (
                id SERIAL PRIMARY KEY,
                conversation_id BIGINT NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
                sender_id BIGINT NOT NULL,
                sender_type VARCHAR(20) NOT NULL,
                sender_name VARCHAR(255) NOT NULL,
                message_type VARCHAR(20) NOT NULL DEFAULT 'TEXT',
                content TEXT NOT NULL,
                attachment_url VARCHAR(500),
                attachment_name VARCHAR(255),
                attachment_size BIGINT,
                is_read BOOLEAN DEFAULT FALSE,
                read_at TIMESTAMP,
                is_deleted BOOLEAN DEFAULT FALSE,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
            );

            CREATE INDEX IF NOT EXISTS idx_msg_conversation_id ON chat_messages(conversation_id);
            CREATE INDEX IF NOT EXISTS idx_msg_sender_id ON chat_messages(sender_id);
            CREATE INDEX IF NOT EXISTS idx_msg_created_at ON chat_messages(created_at);
            CREATE INDEX IF NOT EXISTS idx_msg_is_read ON chat_messages(is_read);
        </sql>
        <rollback>
            <sql>
                DROP INDEX IF EXISTS idx_msg_is_read;
                DROP INDEX IF EXISTS idx_msg_created_at;
                DROP INDEX IF EXISTS idx_msg_sender_id;
                DROP INDEX IF EXISTS idx_msg_conversation_id;
                DROP TABLE IF EXISTS chat_messages;
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
